<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Media Player</title>

  <link rel="stylesheet" href="index.css" />
</head>

<body class="mediaplayer-page">
  <header class="site-header">
    <div class="site-title">S0LACE</div>
    <nav class="site-nav">
      <a href="index.html">Home</a>
      <a href="games.html">Games</a>
      <a href="media.html" class="active">Media</a>
      <a href="apps.html">Apps</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>

  <main>
    <h1 id="media-title">Loading…</h1>

    <!-- PLAYER -->
    <div class="player-wrap">
      <iframe
        id="player-frame"
        allow="fullscreen; autoplay"
        allowfullscreen
        referrerpolicy="no-referrer"
      ></iframe>
    </div>

    <!-- TV SHOW SECTION -->
    <div id="tv-section" style="display:none;">
      <h2>Seasons</h2>
      <select id="season-select"></select>

      <h2 style="margin-top:20px;">Episodes</h2>
      <div id="episode-list" class="episode-list"></div>
    </div>
  </main>

  <script>
    const TMDB_KEY = "2d1351cf74f73892042699d0431b799a";
    const IMG_BASE = "https://image.tmdb.org/t/p/w300";

    const urlParams = new URLSearchParams(location.search);
    const srcParam = urlParams.get("src");
    const titleParam = urlParams.get("title");

    const titleEl = document.getElementById("media-title");
    const playerFrame = document.getElementById("player-frame");
    const seasonSelect = document.getElementById("season-select");
    const episodeList = document.getElementById("episode-list");
    const tvSection = document.getElementById("tv-section");

    // ------------------------------
    //  INITIAL SET TITLE + PLAYER
    // ------------------------------

    if (titleParam) titleEl.textContent = titleParam;

    if (srcParam) {
      playerFrame.src = decodeURIComponent(srcParam);
    }

    // ------------------------------
    //  DETECT IF THIS IS TV SHOW
    // ------------------------------

    let currentTMDB_ID = null;
    const matched = decodeURIComponent(srcParam || "").match(/player\/(\d+)/);

    if (matched) {
      currentTMDB_ID = matched[1];
      loadTVorMovie(currentTMDB_ID);
    }

    // ------------------------------
    //  LOAD IF MOVIE OR TV
    // ------------------------------

    async function loadTVorMovie(id) {
      const res = await fetch(
        `https://api.themoviedb.org/3/movie/${id}?api_key=${TMDB_KEY}`
      );
      if (res.ok) {
        // It's a MOVIE → nothing else needed.
        tvSection.style.display = "none";
        return;
      }

      // Try TV show endpoint
      const tvRes = await fetch(
        `https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_KEY}`
      );
      if (!tvRes.ok) return;

      const tvData = await tvRes.json();
      titleEl.textContent = tvData.name;
      tvSection.style.display = "block";

      buildSeasons(tvData);
      loadSeason(id, 1);
    }

    // ------------------------------
    //  BUILD SEASON DROPDOWN
    // ------------------------------

    function buildSeasons(tvData) {
      seasonSelect.innerHTML = "";
      tvData.seasons.forEach((s) => {
        if (s.season_number === 0) return; // skip specials
        const opt = document.createElement("option");
        opt.value = s.season_number;
        opt.textContent = `Season ${s.season_number}`;
        seasonSelect.appendChild(opt);
      });

      seasonSelect.onchange = () =>
        loadSeason(currentTMDB_ID, parseInt(seasonSelect.value));
    }

    // ------------------------------
    //  LOAD EPISODES FOR SEASON
    // ------------------------------

    async function loadSeason(id, seasonNum) {
      const res = await fetch(
        `https://api.themoviedb.org/3/tv/${id}/season/${seasonNum}?api_key=${TMDB_KEY}`
      );
      const data = await res.json();

      episodeList.innerHTML = "";

      data.episodes.forEach((ep) => {
        const row = document.createElement("div");
        row.className = "episode-row";

        const img = document.createElement("img");
        img.className = "ep-thumb";
        img.src = ep.still_path
          ? IMG_BASE + ep.still_path
          : "thumbs/placeholder-poster.png";

        const meta = document.createElement("div");
        meta.className = "ep-meta";

        const epTitle = document.createElement("div");
        epTitle.className = "ep-title";
        epTitle.textContent = `E${ep.episode_number} • ${ep.name}`;

        row.appendChild(img);
        row.appendChild(meta);
        meta.appendChild(epTitle);

        row.onclick = () => {
          const episodeURL =
            "/scramjet/https://cinemaos.live/player/" +
            id +
            "?s=" +
            seasonNum +
            "&e=" +
            ep.episode_number;

          playerFrame.src = episodeURL;
          titleEl.textContent = `${ep.name} (S${seasonNum}E${ep.episode_number})`;
        };

        episodeList.appendChild(row);
      });
    }
  </script>

  <style>
    /* Compact horizontal episode list */
    .episode-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }

    .episode-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 8px;
      border: 1px solid #333;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.15s;
    }

    .episode-row:hover {
      background: #111;
      transform: scale(1.01);
    }

    .ep-thumb {
      width: 120px;
      height: 68px;
      object-fit: cover;
      border-radius: 4px;
    }

    .ep-meta {
      display: flex;
      flex-direction: column;
    }

    .ep-title {
      font-size: 15px;
      font-weight: 600;
    }
  </style>
</body>
</html>
